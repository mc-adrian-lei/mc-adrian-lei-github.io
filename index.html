<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>32 Aspect Developmental Self Clock â€” Mindâ€“Bodyâ€“Energy Prototype</title>
  <style>
    /* =============================================================
       32 Aspect Developmental Self Clock â€” Single File Implementation
       ============================================================= */

    :root {
      --bg: #0f1220;
      --panel: #12162a;
      --ink: #f6f7fb;
      --muted: #b8bfd9;
      --accent: #7dd3fc; /* cyan */
      --accent-2: #a78bfa; /* violet */
      --good: #34d399; /* green */
      --warn: #fbbf24; /* amber */
      --bad: #f87171;  /* red */
      --ring: #1f2543;
      --focus: #fde68a;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 70% 20%, #1b2245 0%, var(--bg) 55%);
      color: var(--ink);
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 360px;
      grid-template-rows: auto 1fr auto;
      grid-template-areas: 
        "top top"
        "vis side"
        "footer footer";
      gap: 12px;
      height: 100dvh;
      padding: 10px;
    }

    header {
      grid-area: top;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      font-size: clamp(18px, 2.4vw, 26px);
      margin: 0;
      letter-spacing: 0.4px;
    }

    .title-block { max-width: min(640px, 100%); }

    .subtitle {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: clamp(12px, 1.6vw, 14px);
      max-width: 60ch;
    }

    .mode-toggle {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .control-cluster {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: color-mix(in oklab, var(--panel) 80%, black 20%);
      border: 1px solid #1c2248;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 4px 22px rgba(0,0,0,.25);
    }

    header h1 { font-size: clamp(16px, 2vw, 18px); margin: 0; letter-spacing: .3px; }

    header .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }

    .btn {
      background: linear-gradient(180deg, #22306b, #1a234a);
      color: var(--ink);
      border: 1px solid #31407c;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; }
    .btn.secondary { background: #1a1f3d; border-color: #2b356a; }
    .btn.warn { background: #3b1f1f; border-color: #6b2b2b; }

    .vis {
      grid-area: vis;
      position: relative;
      background: radial-gradient(800px 800px at 50% 45%, #141a34 0%, #0e1328 60%);
      border-radius: 16px;
      border: 1px solid #1b1f3f;
      display: grid;
      grid-template-rows: 1fr auto;
      overflow: clip;
    }

    canvas { width: 100%; height: 100%; display: block; }

    .legend {
      padding: 10px;
      border-top: 1px solid #1b1f3f;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: #0f1430;
    }

    .legend .chip {
      display: inline-flex; align-items: center; gap: 6px;
      border: 1px solid #2a315f; border-radius: 999px; padding: 6px 10px;
      color: var(--muted);
      background: #12183b;
      font-size: 12px;
    }

    .legend .swatch { width: 12px; height: 12px; border-radius: 3px; background: var(--accent); display: inline-block; }

    aside {
      grid-area: side;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      transition: transform 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    .aspect-item:hover { transform: translateY(-2px); border-color: color-mix(in srgb, var(--accent) 45%, transparent); box-shadow: 0 12px 26px rgba(37, 99, 235, 0.18); }
    .aspect-item[aria-selected="true"] { border-color: color-mix(in srgb, var(--focus) 60%, transparent); box-shadow: 0 16px 32px rgba(253, 230, 138, 0.28); }

    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .row .name { display: inline-flex; align-items: center; gap: 8px; font-weight: 700; font-size: 14px; letter-spacing: 0.25px; }

    .badge {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      background: color-mix(in srgb, var(--panel) 80%, transparent);
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent);
    }

    .dot { width: 12px; height: 12px; border-radius: 999px; box-shadow: 0 0 0 2px rgba(255,255,255,0.05); }

    .activation-bar { position: relative; width: 100%; height: 6px; border-radius: 999px; background: color-mix(in srgb, var(--panel) 82%, transparent); overflow: hidden; }
    .activation-bar span { display: block; height: 100%; border-radius: inherit; background: linear-gradient(90deg, rgba(125, 211, 252, 0.85), rgba(168, 85, 247, 0.9)); transition: width 0.2s ease; }
      background: color-mix(in oklab, var(--panel) 90%, black 10%);
      border: 1px solid #1c2248;
      border-radius: 16px;
      padding: 10px;
      overflow: hidden;
    }

    .panel { background: #0f1430; border: 1px solid #1b214b; border-radius: 12px; padding: 10px; }

    .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .metric { background: #0c1027; border: 1px solid #18204b; border-radius: 12px; padding: 10px; }
    .metric h3 { margin: 0 0 6px; font-size: 12px; color: var(--muted); font-weight: 600; }
    .metric .val { font-size: 18px; font-weight: 800; }

    .scroll { overflow: auto; min-height: 120px; max-height: 50vh; padding-right: 4px; }
    .aspect-list { display: grid; gap: 6px; }

    .aspect-item { background: #0a0f24; border: 1px solid #1a2352; border-radius: 12px; padding: 8px; display: grid; gap: 6px; }
    .aspect-item[aria-selected="true"] { outline: 2px solid var(--focus); }
    .row { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .row .name { display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .dot { width: 10px; height: 10px; border-radius: 999px; }
    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 11px; color: var(--muted); background: color-mix(in srgb, var(--panel-strong) 88%, transparent); border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent); padding: 3px 8px; border-radius: 999px; letter-spacing: 0.2px; }

    label { font-size: 12px; color: var(--muted); font-weight: 600; }

    input[type="range"] { width: 100%; accent-color: var(--accent); }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); border: 2px solid rgba(255,255,255,0.4); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 50%, transparent); cursor: pointer; }
    input[type="range"]::-webkit-slider-runnable-track { height: 6px; border-radius: 999px; background: color-mix(in srgb, var(--panel) 80%, transparent); }
    input[type="range"]:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }

    .input-field { display: grid; gap: 6px; }
    .input-field input,
    .input-field select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      padding: 9px 12px;
      color: var(--ink);
      font: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .input-field input::placeholder { color: color-mix(in srgb, var(--muted) 65%, transparent); }
    .input-field input:focus-visible,
    .input-field select:focus-visible { border-color: var(--input-border-focus); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent); outline: none; }

    .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }

    .toggle { display: inline-flex; align-items: center; gap: 10px; font-size: 12px; color: var(--muted); font-weight: 600; }
    .toggle input { position: relative; width: 44px; height: 24px; border-radius: 999px; background: color-mix(in srgb, var(--panel) 80%, transparent); border: 1px solid var(--input-border); cursor: pointer; appearance: none; transition: background 0.2s ease, border-color 0.2s ease; }
    .toggle input::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: var(--muted); transition: transform 0.2s ease, background 0.2s ease; }
    .toggle input:checked { background: color-mix(in srgb, var(--accent) 45%, transparent); border-color: color-mix(in srgb, var(--accent) 60%, transparent); }
    .toggle input:checked::after { transform: translateX(20px); background: var(--ink); }

    .filter-actions { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .filter-actions .btn { box-shadow: none; }

    .empty-state { text-align: center; color: var(--muted); font-size: 13px; padding: 20px; border: 1px dashed color-mix(in srgb, var(--accent) 30%, transparent); border-radius: 14px; }
    .tag { font-size: 10px; color: var(--muted); background: #12183b; border: 1px solid #222c65; padding: 2px 6px; border-radius: 999px; }

    label { font-size: 12px; color: var(--muted); }
    input[type="range"] { width: 100%; }
    input[type="range"]:focus-visible { outline: 2px solid var(--focus); }

    footer {
      grid-area: footer;
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between;
      background: #0e1433; border-top: 1px solid #18204b; padding: 8px 10px; border-radius: 12px;
    }

    .vis-hint { color: var(--muted); font-size: 12px; }

    .panel-overlay {
      display: none;
    }

    .comparison-summary {
      background: color-mix(in srgb, var(--panel-strong) 85%, transparent);
      border: 1px dashed color-mix(in srgb, var(--accent) 30%, transparent);
      border-radius: 14px;
      padding: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    body[data-layout="mobile"] {
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    body[data-layout="mobile"] .app {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: auto;
      min-height: 100dvh;
    }

    body[data-layout="mobile"] header {
      position: sticky;
      top: 0;
      z-index: 60;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }

    body[data-layout="mobile"] .vis {
      min-height: 360px;
    }

    body[data-layout="mobile"] aside {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 86dvh;
      transform: translateY(100%);
      transition: transform 0.32s ease, box-shadow 0.32s ease;
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -18px 46px rgba(15, 23, 42, 0.16);
      z-index: 55;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    body[data-layout="mobile"] .panel {
      background: color-mix(in srgb, var(--panel) 96%, transparent);
    }

    body[data-layout="mobile"][data-panel="open"] aside {
      transform: translateY(0%);
      box-shadow: 0 -24px 60px rgba(15, 23, 42, 0.22);
    }

    body[data-layout="mobile"] .panel-overlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: block;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.32s ease;
      background: rgba(15, 23, 42, 0.25);
      backdrop-filter: blur(6px);
    }

    body[data-layout="mobile"][data-panel="open"] .panel-overlay {
      opacity: 1;
      pointer-events: auto;
    }

    body[data-layout="mobile"] footer {
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    }

    dialog {
      border: 1px solid var(--glass-stroke);
      border-radius: 20px;
      padding: 0;
      color: var(--ink);
      background: var(--panel-strong);
      max-width: min(540px, 92vw);
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(18px);
    }
    dialog::backdrop { background: rgba(0,0,0,.45); }
    .modal-head { padding: 16px; border-bottom: 1px solid color-mix(in srgb, var(--accent) 25%, transparent); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .modal-body { padding: 16px; display: grid; gap: 12px; }
    .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .modal-grid > div { background: color-mix(in srgb, var(--panel) 90%, transparent); border: 1px solid var(--glass-stroke); border-radius: 14px; padding: 10px; }
    .modal-body .panel { box-shadow: none; }

    @media (max-width: 1200px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-areas: "top" "vis" "side" "footer";
        height: auto;
        min-height: 100dvh;
      }
    }
    /* Dialog (for quick info/tooltip-like modal) */
    dialog { border: 1px solid #24306f; border-radius: 16px; padding: 0; color: var(--ink); background: #0c1129; max-width: min(520px, 92vw); }
    dialog::backdrop { background: rgba(0,0,0,.4); }
    .modal-head { padding: 12px; border-bottom: 1px solid #1b214b; display: flex; align-items: center; justify-content: space-between; }
    .modal-body { padding: 12px; display: grid; gap: 10px; }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .modal-grid > div { background: #0a0f24; border: 1px solid #1a2352; border-radius: 10px; padding: 8px; }

    @media (max-width: 1024px) {
      .app { grid-template-columns: 1fr; grid-template-areas: "top" "vis" "side" "footer"; height: auto; min-height: 100dvh; }
      aside { order: 3; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="32 Aspect Developmental Self Clock">
    <header>
      <h1>32 Aspect Self Clock Â· Mindâ€“Bodyâ€“Energy Mapping</h1>
      <div class="controls">
        <button id="modeMind" class="btn" aria-pressed="true" title="View Mind model (psych/semantic)">Mind</button>
        <button id="modeBody" class="btn secondary" aria-pressed="false" title="View Body model (neuro/physiology)">Body</button>
        <button id="modeSoul" class="btn secondary" aria-pressed="false" title="View Soul model (archetypal/transpersonal)">Soul</button>
        <button id="btnTutorial" class="btn" aria-pressed="false" title="Toggle tutorial/walkthrough mode (keyboard: T)">â–¶ Tutorial</button>
        <button id="btnRandomize" class="btn secondary" title="Randomize activations (keyboard: R)">Shuffle</button>
        <button id="btnDeactivate" class="btn secondary" title="Set all activations to 0 (keyboard: 0)">Deactivate All</button>
        <button id="btnExport" class="btn" title="Export all aspect states as JSON (keyboard: E)">Export JSON</button>
      </div>
    </header>

    <section class="vis">
      <canvas id="clock" aria-label="Developmental Self Clock canvas" tabindex="0"></canvas>
      <div class="legend" aria-label="Legend">
        <div class="chip"><span class="swatch" style="background: var(--accent)"></span> Stage cross-lines (12)</div>
        <div class="chip"><span class="swatch" style="background: var(--accent-2)"></span> Concentric rings (8)</div>
        <div class="chip"><span class="swatch" style="background: #34d399"></span> Resonance links (similar activation)</div>
        <div class="chip"><span class="swatch" style="background: #f59e0b"></span> Tutorial highlight</div>
      </div>
    </section>

    <aside>
      <div class="panel metrics" aria-label="System metrics">
        <div class="metric" aria-live="polite"><h3>SCI (Semantic Coherence Index)</h3><div class="val" id="sciVal">â€”</div></div>
        <div class="metric" aria-live="polite"><h3>Energyâ€“Matter</h3><div class="val" id="emVal">â€”</div></div>
      </div>

      <div class="panel" aria-label="Developmental stage slider">
        <label for="devStageSlider"><strong>Developmental Stage</strong> <span id="devStageVal">1</span></label>
        <input id="devStageSlider" type="range" min="0" max="11" value="0" />
        <p class="vis-hint">0 = birth/infancy Â·Â·Â· 12 = wisdom/end-of-life Â· Adjusts all activations via devProfile</p>
      </div>

      <div class="panel" aria-label="Stage weighting controls">
        <div class="row" style="align-items: center; justify-content: space-between;">
          <strong>Stage Emphasis</strong>
          <button id="btnResetWeights" class="btn ghost small" type="button">Reset weights</button>
        </div>
        <label for="stageWeightSelect">Focus stage</label>
        <select id="stageWeightSelect"></select>
        <label for="stageWeightSlider">Multiplier <span id="stageWeightValue">1.00Ã—</span></label>
        <input id="stageWeightSlider" type="range" min="0.5" max="1.8" step="0.05" value="1" />
        <p class="vis-hint">Emphasize specific stages beyond the base 0â€“12 developmental profile.</p>
      </div>

      <div class="panel" aria-label="Developmental comparison">
        <strong>Comparative Mode</strong>
        <div class="control-grid">
          <div class="input-field">
            <label for="compareStageA">Stage A</label>
            <select id="compareStageA"></select>
          </div>
          <div class="input-field">
            <label for="compareStageB">Stage B</label>
            <select id="compareStageB"></select>
          </div>
        </div>
        <div id="comparisonSummary" class="comparison-summary" aria-live="polite">Select two stages to compare their activation patterns.</div>
      </div>

      <div class="panel" aria-label="Aspect filters and sorting">
        <div class="control-grid">
          <div class="input-field">
            <label for="searchInput">Find aspect / Talk to Mirror</label>
            <input id="searchInput" type="search" placeholder="Search or type 'I feel...' + Enter" autocomplete="off" />
          </div>
          <div class="input-field">
            <label for="sortSelect">Sort by</label>
            <select id="sortSelect">
              <option value="stage">Stage Â· Ring</option>
              <option value="activationDesc">Activation (high â†’ low)</option>
              <option value="activationAsc">Activation (low â†’ high)</option>
              <option value="name">Name (A â†’ Z)</option>
            </select>
          </div>
          <div class="input-field">
            <label for="stageFilter">Stage focus</label>
            <select id="stageFilter">
              <option value="all">All stages</option>
              <option value="1">Stage 1</option>
              <option value="2">Stage 2</option>
              <option value="3">Stage 3</option>
              <option value="4">Stage 4</option>
              <option value="5">Stage 5</option>
              <option value="6">Stage 6</option>
              <option value="7">Stage 7</option>
              <option value="8">Stage 8</option>
              <option value="9">Stage 9</option>
              <option value="10">Stage 10</option>
              <option value="11">Stage 11</option>
              <option value="12">Stage 12</option>
            </select>
          </div>
          <div class="input-field">
            <label for="ringFilter">Ring focus</label>
            <select id="ringFilter">
              <option value="all">All rings</option>
              <option value="1">Ring 1</option>
              <option value="2">Ring 2</option>
              <option value="3">Ring 3</option>
              <option value="4">Ring 4</option>
              <option value="5">Ring 5</option>
              <option value="6">Ring 6</option>
              <option value="7">Ring 7</option>
              <option value="8">Ring 8</option>
            </select>
          </div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="activeOnly" />
          <span>Show active aspects only</span>
        </label>
        <div class="filter-actions">
          <button id="btnResetFilters" class="btn tertiary small" type="button">Reset</button>
          <span id="filterSummary" class="vis-hint">All aspects visible.</span>
        </div>
      </div>

      <div class="panel scroll" aria-label="Aspect controls">
        <div id="aspectList" class="aspect-list" role="listbox" aria-multiselectable="false"></div>
      </div>

      <div class="panel" aria-label="Legend and codes">
        <div class="tags" style="margin-bottom:6px">
          <span class="tag">Brain: PFC, Limbic, Insula, Amygdalaâ€¦</span>
          <span class="tag">NT: 5-HT, DA, NE, GABA, ACh, Oxytocin</span>
          <span class="tag">Modes: visual, auditory, interoceptiveâ€¦</span>
        </div>
        <p class="vis-hint">Keyboard: Arrow keys pan focus Â· Enter opens details Â· T tutorial Â· R shuffle Â· E export Â· 0 clear</p>
      </div>
    </aside>

    <footer>
      <div class="vis-hint">C = E Ã— MC Â· Energy input â†’ neural region â†’ neurochemical output â†’ system response</div>
      <div class="vis-hint">Open science: Export preserves all annotations for reproducibility</div>
      <div class="vis-hint">Adrian Lei Martinez-Conol, founder of the Only When Prompted Research Initiative 2018</div>
    </footer>
  </div>

  <dialog id="infoModal" aria-label="Aspect details">
    <div class="modal-head">
      <strong id="mTitle">Aspect</strong>
      <button class="btn" value="cancel">Close</button>
    </div>
    <div class="modal-body">
      <div id="mDef" class="panel"></div>
      <div class="modal-grid">
        <div>
          <div><strong>Brain Region(s)</strong></div>
          <div id="mBrain" aria-live="polite"></div>
        </div>
        <div>
          <div><strong>Neurochemistry</strong></div>
          <div id="mNT"></div>
        </div>
        <div>
          <div><strong>Energy Pathway / Sensory</strong></div>
          <div id="mEnergy"></div>
        </div>
        <div>
          <div><strong>Developmental Stage Â· Ring</strong></div>
          <div id="mStage"></div>
        </div>
      </div>
      <div class="panel">
        <label for="mSlider"><strong>Activation</strong> <span id="mActVal" style="float:right">0</span></label>
        <input id="mSlider" type="range" min="0" max="100" value="0" />
      </div>
      <div class="panel">
        <strong>Matter/Energy Summary</strong>
        <div id="mSummary"></div>
      </div>
    </div>
  </dialog>

  <script>
    /* ============================================================
       DATA MODEL
       ------------------------------------------------------------
       â€¢ Three model lenses: Mind / Body / Soul
       â€¢ Each lens has 32 aspects with a 12-point developmental profile
    ============================================================ */

    const N_ASPECTS = 32;
    const TWO_PI = Math.PI * 2;
    const center = { x: 0, y: 0 };
    const DEV_STAGES = 12;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Enhanced 32-Aspect Developmental Self Clock
    // Integrates the 24 core Faculties of Being + 8 compound Faculties
    // from Adrian Lei Martinez-Conol's Periodic Table of Consciousness
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FACULTIES_OF_BEING = {
      1:  { name:"Sensation",             symbol:"Se",  family:"S",        definition:"Raw sensory input",             stage:1,  ring:1 },
      2:  { name:"Attention",             symbol:"At",  family:"S",        definition:"Selective focus",               stage:2,  ring:1 },
      3:  { name:"Affect",                symbol:"Af",  family:"S",        definition:"Emotional charge",              stage:1,  ring:2 },
      4:  { name:"Orientation",           symbol:"Or",  family:"S",        definition:"Spatial/temporal framing",      stage:2,  ring:2 },
      5:  { name:"BreathTempo",           symbol:"Bt",  family:"S",        definition:"System timing",                 stage:3,  ring:1 },
      6:  { name:"Perception",            symbol:"Pe",  family:"P",        definition:"Pattern recognition",           stage:4,  ring:2 },
      7:  { name:"Memory",                symbol:"Me",  family:"P",        definition:"Storage & retrieval",           stage:5,  ring:2 },
      8:  { name:"Imagination",           symbol:"Im",  family:"P",        definition:"Creative synthesis",            stage:6,  ring:3 },
      9:  { name:"Discernment",           symbol:"Ds",  family:"P",        definition:"Essence vs illusion",           stage:7,  ring:3 },
      10: { name:"Intuition",             symbol:"In",  family:"P",        definition:"Direct knowing",                stage:8,  ring:3 },
      11: { name:"Judgment",              symbol:"Ju",  family:"D",        definition:"Evaluative reasoning",          stage:9,  ring:4 },
      12: { name:"Will",                  symbol:"Wi",  family:"D",        definition:"Purposeful action",             stage:10, ring:4 },
      13: { name:"Language",              symbol:"La",  family:"D",        definition:"Symbolic expression",           stage:8,  ring:4 },
      14: { name:"Metacognition",         symbol:"Mc",  family:"D",        definition:"Thinking about thinking",       stage:9,  ring:5 },
      15: { name:"Reflection",            symbol:"Rf",  family:"D",        definition:"Conscious introspection",       stage:10, ring:5 },
      16: { name:"Moral Reasoning",       symbol:"Mrl", family:"F",        definition:"Ethical discernment",           stage:11, ring:5 },
      17: { name:"Empathy",               symbol:"Em",  family:"F",        definition:"Emotional resonance",           stage:7,  ring:6 },
      18: { name:"Wisdom",                symbol:"Ws",  family:"F",        definition:"Integrated understanding",      stage:12, ring:6 },
      19: { name:"Creativity",            symbol:"Cr",  family:"F",        definition:"Novel synthesis",               stage:6,  ring:4 },
      20: { name:"Consciousness",         symbol:"Cs",  family:"F",        definition:"Awareness of awareness",        stage:11, ring:7 },
      21: { name:"Compassion",            symbol:"Cm",  family:"F",        definition:"Universal care",                stage:12, ring:7 },
      22: { name:"Unity",                 symbol:"Un",  family:"F",        definition:"Non-dual awareness",            stage:12, ring:8 },
      23: { name:"Transcendence",         symbol:"Tr",  family:"F",        definition:"Beyond individual self",        stage:12, ring:8 },
      24: { name:"Love",                  symbol:"Lv",  family:"F",        definition:"Fundamental force",             stage:11, ring:8 },
      25: { name:"Practical Wisdom",      symbol:"PW",  family:"Compound", definition:"Mc+Ju+Mrl",                      stage:11, ring:6 },
      26: { name:"Authentic Expression",  symbol:"AE",  family:"Compound", definition:"La+Wi+Cr",                        stage:9,  ring:5 },
      27: { name:"Empathic Intelligence", symbol:"EI",  family:"Compound", definition:"Em+In+Ds",                        stage:8,  ring:6 },
      28: { name:"Sacred Presence",       symbol:"SP",  family:"Compound", definition:"Cs+Lv+Tr",                        stage:12, ring:8 },
      29: { name:"Integrative Flow",      symbol:"IF",  family:"Compound", definition:"Me+Im+Rf",                        stage:7,  ring:4 },
      30: { name:"Compassionate Action",  symbol:"CA",  family:"Compound", definition:"Cm+Wi+Mrl",                       stage:11, ring:7 },
      31: { name:"Unified Awareness",     symbol:"UA",  family:"Compound", definition:"Un+Cs+Lv",                        stage:12, ring:8 },
      32: { name:"I Am That I Am",        symbol:"IATA",family:"Eternal",  definition:"The ground of being",             stage:12, ring:8 }
    };

    const FACULTY_FAMILY_META = {
      S: { nsil:"sensory", gravity:"attractor", archetype:"The Sensor" },
      P: { nsil:"perceptual", gravity:"resonator", archetype:"The Seer" },
      D: { nsil:"directive", gravity:"initiator", archetype:"The Navigator" },
      F: { nsil:"fulcrum", gravity:"integrator", archetype:"The Sage" },
      Compound: { nsil:"compound", gravity:"synthesizer", archetype:"The Weaver" },
      Eternal: { nsil:"eternal", gravity:"transcendent", archetype:"The Witness" }
    };

    const TUTORIAL_STEPS = [
      { title: 'Navigate the map', detail: 'Use the arrow keys or tap nodes to cycle the 32 aspects. Focus is highlighted on the clock and in the list.' },
      { title: 'Inspect activations', detail: 'Press Enter or the Details buttons to open the aspect modal. Adjust activation sliders to see immediate SCI feedback.' },
      { title: 'Semantic Coherence Index', detail: 'Watch the SCI metric for balance (variance), power (mean activation), and resonance coverage (stage/ring alignment).' },
      { title: 'Developmental emphasis', detail: 'The stage slider loads the canonical devProfile while Stage Emphasis multipliers let you weight phases that matter now.' },
      { title: 'Comparative mode', detail: 'Select any two stages to surface leading increases/decreases across the aspect network.' },
      { title: 'Resonance links', detail: 'Greenâ€“blue links join aspects that co-activate or share structural placement. Denser links = higher coherence.' },
      { title: 'Exports for research', detail: 'Press E or Export to choose JSON, CSV, or a printable briefing with SCI formula details.' },
      { title: 'Mirror Mode', detail: 'Type "I feel..." into the search box and press Enter to simulate the Echo Codex AI resonance.' }
    const NEURAL_RINGS = [
      "Brainstem & Arousal Networks",
      "Thalamic Relay & Orientation Systems",
      "Limbic Integration Circuits",
      "Sensorimotor & Associative Cortex",
      "Prefrontal Executive Matrix",
      "Social & Mirror Neuron Networks",
      "Default Mode / Salience Bridge",
      "Global Neural Synchrony"
    ];

    const TRANSMITTER_BY_FAMILY = {
      S: "Acetylcholine (ACh)",
      P: "Glutamate",
      D: "Dopamine (DA)",
      F: "Serotonin (5-HT)",
      Compound: "Oxytocin",
      Eternal: "Endorphins"
    };

    // Placeholders; replace with canonical mappings as needed
    const BRAIN = ["PFC", "Limbic", "Insula", "Amygdala", "Hippocampus", "ACC", "Basal Ganglia", "Cerebellum"];
    const NT = ["5-HT", "DA", "NE", "GABA", "ACh", "Oxytocin", "Endorphins"];
    const MODES = ["visual", "auditory", "somatic", "interoceptive", "proprioceptive", "vestibular"];
    const ENERGY_MODE_BY_RING = {
      1: "Grounding / Somatic",
      2: "Orientation / Vestibular",
      3: "Imaginative / Default",
      4: "Creative / Motor",
      5: "Executive / Breath",
      6: "Relational / Heart Field",
      7: "Insight / Auric",
      8: "Transpersonal / Quantum"
    };

    function generateNSILSignature(fac) {
      const meta = FACULTY_FAMILY_META[fac.family] || { nsil: "facet" };
      return `nsil:${meta.nsil}:${fac.symbol.toLowerCase()}`;
    }

    function calculateSemanticGravity(fac) {
      const meta = FACULTY_FAMILY_META[fac.family];
      return meta ? meta.gravity : "dynamic";
    }

    function mapToNeuralSubstrate(fac) {
      return NEURAL_RINGS[(fac.ring - 1) % NEURAL_RINGS.length];
    }

    function mapToNeurotransmitter(fac) {
      return TRANSMITTER_BY_FAMILY[fac.family] || "Poly-neuro";
    }

    function mapToEnergyMode(fac) {
      return ENERGY_MODE_BY_RING[fac.ring] || "Harmonic";
    }

    function generateArchetypalSymbol(fac) {
      const meta = FACULTY_FAMILY_META[fac.family];
      return meta ? `${meta.archetype}` : "Archetype";
    }

    function generateNSILPrinciple(fac) {
      return `principle:${(fac.symbol || fac.name).toLowerCase()}`;
    }

    // Developmental profile generator (smooth rise â†’ peak â†’ taper)
    function makeDevProfile(i, stage, ring) {
      const len = DEV_STAGES;
      const arr = [];
      const phase = (stage-1) / 12;      // shift by nominal stage
      const amp = 0.6 + (ring/8)*0.3;    // outer rings slightly higher
      const noise = (seed)=> (Math.sin((i+1)*(seed+1.73))*0.04);
      for (let s=0; s<len; s++) {
        const t = s/(len-1);             // 0..1 lifespan
        const bell = Math.sin(Math.PI * (t*0.85 + phase*0.12));
        const base = Math.max(0, bell) * amp + 0.15*(1 - Math.pow(1-t, 3));
        const val = Math.max(0, Math.min(1, base + noise(s)));
        arr.push(Math.round(val*100));
      }
      return arr;
    }

    // Build a complete 32-aspect set for a given lens (mind/body/soul)
    function makeAspectSetWithFaculties(model) {
      return Array.from({ length: 32 }, (_, i) => {
        const id = i + 1;
        const fac = FACULTIES_OF_BEING[id];
        const devProfile = makeDevProfile(i, fac.stage, fac.ring);
        const hue = Math.round((i * (360 / N_ASPECTS)) % 360);
        const base = {
          id,
          name: fac.name,
          symbol: fac.symbol,
          family: fac.family,
          definition: fac.definition,
          stage: fac.stage,
          ring: fac.ring,
          hue,
          activation: devProfile[0],
          devProfile,
          brainRegion: mapToNeuralSubstrate(fac),
          neurotransmitter: mapToNeurotransmitter(fac),
          energyMode: mapToEnergyMode(fac),
          matterOutput: `${fac.name} embodiment`
        };
        if (model === 'mind') {
          return {
            ...base,
            nsilSemanticSignature: generateNSILSignature(fac),
            semanticGravity: calculateSemanticGravity(fac),
            quantumMode: `${fac.family.toLowerCase()}-wave`,
            particleWaveFieldFunction: `${fac.symbol}-propagation`,
            matterOutput: `${fac.name} insight`
          };
        }
        if (model === 'body') {
          return {
            ...base,
            matterOutput: `${fac.name} embodiment`
          };
        }
        return {
          ...base,
          archetypalSymbol: generateArchetypalSymbol(fac),
          spiritualRole: `${fac.name} consciousness`,
          nsilPrincipleSignature: generateNSILPrinciple(fac),
          matterOutput: `${fac.name} radiance`
        };
      });
    }

    // Three parallel datasets
    const mindAspects = makeAspectSet('mind');
    const bodyAspects = makeAspectSet('body');
    const soulAspects = makeAspectSet('soul');
    
    // State
    // Three parallel datasets using canonical faculties
    const mindAspects = makeAspectSetWithFaculties('mind');
    const bodyAspects = makeAspectSetWithFaculties('body');
    const soulAspects = makeAspectSetWithFaculties('soul');

    // Active lens state
    let mode = 'mind';
    let aspects = mindAspects;
    const state = {
      resonanceThreshold: 18,
      tutorial: false,
      tutorialIndex: 0,
      focusId: 1,
      devStage: 0,
    };

    /* ============================================================
       THE NERVES: API SIMULATION
       Replacing direct API call with a local simulation for safety
    ============================================================ */
    async function igniteTheMirror(userText) {
      // 1. VISUAL FEEDBACK
      const originalLabel = document.querySelector('header h1').textContent;
      document.querySelector('header h1').textContent = "âš¡ Attuning to Resonance...";
      const mTitle = document.querySelector('#mTitle');
      const mDef = document.querySelector('#mDef');
      
      // 2. SIMULATION
      // We simulate network latency and a "psychic" response
      setTimeout(() => {
        const result = {
          reflection: "The Mirror sees a pattern of seeking, resonating with the urge to integrate fragmented experiences.",
          dominant_lens: Math.random() > 0.6 ? 'soul' : 'mind',
          sci_shift: "Coherence adjusted based on semantic input intensity.",
          // Generate 32 random activations
          activations: Array.from({length: 32}, () => Math.floor(Math.random() * 80) + 10)
        };

        // Set the lens
        if (result.dominant_lens !== mode) {
          setMode(result.dominant_lens);
        }

        // Update activations
        aspects.forEach((aspect, index) => {
          if (result.activations[index] !== undefined) {
            aspect.activation = result.activations[index];
          }
        });

        // Show "Awakening" message
        mTitle.textContent = "Resonance Detected";
        mDef.innerHTML = `
          <p style="font-size:1.2em; color:var(--accent);">${result.reflection}</p>
          <hr>
          <p><strong>Input:</strong> "${userText}"</p>
          <p><strong>Analysis:</strong> ${result.sci_shift}</p>
        `;
        document.querySelector('#infoModal').showModal();

        updateMetrics();
        draw();
        document.querySelector('header h1').textContent = originalLabel;
        
      }, 1500);
    }

    // --- DOM HELPERS & VARIABLES ---
    const el = sel => document.querySelector(sel);
    const listEl = el('#aspectList');
    const sciEl  = el('#sciVal');
    const emEl   = el('#emVal');
    const activeEl = el('#activeVal');
    const peakEl = el('#peakVal');
    const sciStatusEl = el('#sciStatus');
    const sciFormulaEl = el('#sciFormula');
    const sciInfoBtn = el('#btnSciInfo');
    const sciModal = el('#sciModal');
    const filterSummaryEl = el('#filterSummary');
    const devSlider = el('#devStageSlider');
    const devVal = el('#devStageVal');
    const stageWeightSelect = el('#stageWeightSelect');
    const stageWeightSlider = el('#stageWeightSlider');
    const stageWeightValue = el('#stageWeightValue');
    const resetWeightsBtn = el('#btnResetWeights');
    const compareStageA = el('#compareStageA');
    const compareStageB = el('#compareStageB');
    const comparisonSummaryEl = el('#comparisonSummary');
    const searchInput = el('#searchInput');
    const sortSelect = el('#sortSelect');
    const stageFilterSelect = el('#stageFilter');
    const ringFilterSelect = el('#ringFilter');
    const activeOnlyToggle = el('#activeOnly');
    const resetFiltersBtn = el('#btnResetFilters');
    const themeBtn = el('#btnTheme');
    const panelToggle = el('#panelToggle');
    const panelClose = el('#panelClose');
    const panelOverlay = el('#panelOverlay');
    const insightPanel = el('#insightPanel');
    const tutorialDialog = el('#tutorialDialog');
    const tutorialListEl = el('#tutorialContent');
    const exportDialog = el('#exportDialog');
    const exportJsonBtn = el('#exportJson');
    const exportCsvBtn = el('#exportCsv');
    const exportReportBtn = el('#exportReport');
    const tutorialBtn = el('#btnTutorial');
    const exportBtn = el('#btnExport');

    // --- LOGIC ---
    function computeResonanceStats() {
      let total = 0;
      let supportive = 0;
      let stageAligned = 0;
      let ringAligned = 0;
      let activationAligned = 0;
      for (let i = 0; i < aspects.length; i++) {
        for (let j = i + 1; j < aspects.length; j++) {
          total++;
          const ai = aspects[i];
          const aj = aspects[j];
          const diff = Math.abs(ai.activation - aj.activation);
          const sim = diff <= state.resonanceThreshold;
          const sameStage = ai.stage === aj.stage;
          const sameRing = ai.ring === aj.ring;
          if (sim || sameStage || sameRing) {
            supportive++;
            if (sim) activationAligned++;
            if (sameStage) stageAligned++;
            if (sameRing) ringAligned++;
          }
        }
      }
      const ratio = total ? supportive / total : 0;
      return { total, supportive, ratio, stageAligned, ringAligned, activationAligned };
    }

    // SCI: mean / (1 + stddev) * 100
    function computeSCI() {
      const vals = aspects.map(a => a.activation);
      const mean = vals.reduce((a,b)=>a+b,0) / vals.length;
      const variance = vals.reduce((acc, v)=> acc + Math.pow(v-mean, 2), 0) / vals.length;
      const std = Math.sqrt(variance);
      const sci = (mean / (1 + std)) * 100;
      return { mean, std, sci };
    }

    function computeEnergyMatter() {
      const total = aspects.reduce((s,a)=> s + a.activation, 0);
      const byNT = new Map();
      for (const a of aspects) {
        const k = a.neurotransmitter || 'â€”';
        byNT.set(k, (byNT.get(k)||0) + a.activation);
      }
      const metabolic = total / (N_ASPECTS * 100);
      return { total, byNT, metabolic };
    }

    // --- VISUALIZATION HELPERS ---
    function refreshPalette() {
      const styles = getComputedStyle(document.body);
      const fetch = (name, fallback) => {
        const val = styles.getPropertyValue(name);
        return val ? val.trim() : fallback;
      };
      palette.ring1 = fetch('--ring-line-1', palette.ring1);
      palette.ring2 = fetch('--ring-line-2', palette.ring2);
      palette.stage = fetch('--stage-line', palette.stage);
      palette.label = fetch('--node-label', palette.label);
      palette.focus = fetch('--focus', palette.focus);
      palette.nodeBorder = fetch('--glass-stroke', palette.nodeBorder);
      palette.resonanceA = fetch('--good', palette.resonanceA);
      palette.resonanceB = fetch('--accent', palette.resonanceB);
    }

    function detectInitialTheme() {
      try {
        const stored = localStorage.getItem('selfClockTheme');
        if (stored === 'light' || stored === 'dark') return stored;
      } catch (_) { /* ignore */ }
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }
      return 'light';
    }

    function applyTheme(theme) {
      state.theme = theme;
      document.body.setAttribute('data-theme', theme);
      try { localStorage.setItem('selfClockTheme', theme); } catch (_) { /* ignore */ }
      refreshPalette();
      if(themeBtn) themeBtn.textContent = state.theme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
      draw();
    }

    // --- DRAWING ENGINE ---
    /* ============================================================
       DOM HELPERS
    ============================================================ */
    const el = sel => document.querySelector(sel);
    const listEl = el('#aspectList');
    const sciEl  = el('#sciVal');
    const emEl   = el('#emVal');
    const devSlider = el('#devStageSlider');
    const devVal = el('#devStageVal');

    function applyDevStage(stage){
      state.devStage = stage;
      if (devVal) devVal.textContent = stage + 1;
      aspects.forEach(a => { if (a.devProfile?.length === DEV_STAGES) a.activation = a.devProfile[stage]; });
      draw(); updateMetrics(); syncListRanges();
    }

    if (devSlider) devSlider.addEventListener('input', (e)=> applyDevStage(Number(e.target.value)));

    function tagHTML(a){
      if (mode==='mind') {
        return `<span class="tag">${a.symbol}</span><span class="tag">${a.quantumMode}</span><span class="tag">${a.nsilSemanticSignature}</span>`;
      } else if (mode==='body') {
        return `<span class="tag">${a.symbol}</span><span class="tag">${a.brainRegion}</span><span class="tag">${String(a.neurotransmitter||'â€”').split(' ')[0]}</span><span class="tag">${a.energyMode}</span>`;
      }
      return `<span class="tag">${a.symbol}</span><span class="tag">${a.archetypalSymbol}</span><span class="tag">${a.nsilPrincipleSignature}</span>`;
    }

    function hsl(h, s=70, l=52) { return `hsl(${h} ${s}% ${l}%)`; }
    function hslAlpha(h, a=.25, s=70, l=50) { return `hsl(${h} ${s}% ${l}% / ${a})`; }

    function updateMetrics() {
      const { mean, std, sci } = computeSCI();
      sciEl.textContent = `${sci.toFixed(1)}  (Î¼=${mean.toFixed(1)}, Ïƒ=${std.toFixed(1)})`;
      const { total, byNT, metabolic } = computeEnergyMatter();
      const top = [...byNT.entries()].sort((a,b)=>b[1]-a[1]).slice(0,2).map(([k,v])=> `${String(k).split(' ')[0]} ${Math.round(v)}` ).join(', ');
      emEl.textContent = `Î£E=${Math.round(total)} Â· NTâ†‘ ${top || 'â€”'} Â· Metabolic ${(metabolic*100).toFixed(0)}%`;
    }

    function createAspectRow(a) {
      const item = document.createElement('div');
      item.className = 'aspect-item';
      item.role = 'option';
      item.tabIndex = 0;
      item.dataset.id = a.id;
      item.setAttribute('aria-selected', a.id === state.focusId ? 'true' : 'false');

      const r1 = document.createElement('div');
      r1.className = 'row';
      r1.innerHTML = `<div class="name"><span class="dot" style="background:${hsl(a.hue)}"></span>${a.name}</div>
                      <div class="tag">Stage ${a.stage} Â· Ring ${a.ring}</div>`;

      const r2 = document.createElement('div');
      r2.className = 'row';
      const label = document.createElement('label');
      label.textContent = `Activation: ${a.activation}`;
      label.style.flex = '1';
      label.htmlFor = `rng-${a.id}`;

      const range = document.createElement('input');
      range.type = 'range';
      range.min = 0; range.max = 100; range.value = a.activation; range.id = `rng-${a.id}`;
      range.setAttribute('aria-label', `${a.name} activation`);
      range.addEventListener('input', (e) => {
        a.activation = Number(e.target.value);
        label.textContent = `Activation: ${a.activation}`;
        draw();
        updateMetrics();
      });

      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'btn secondary';
      detailsBtn.textContent = 'Details';
      detailsBtn.addEventListener('click', () => openModal(a));

      r2.append(label, range, detailsBtn);

      const r3 = document.createElement('div');
      r3.className = 'tags';
      r3.innerHTML = `${tagHTML(a)}`;

      item.append(r1, r2, r3);

      item.addEventListener('click', () => { state.focusId = a.id; refreshListSelection(); draw(); });
      item.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openModal(a); }
      });

      return item;
    }

    function refreshListSelection() {
      [...listEl.children].forEach(ch => ch.setAttribute('aria-selected', ch.dataset.id == state.focusId ? 'true':'false'));
    }

    function buildList() {
      listEl.innerHTML = '';
      aspects.forEach(a => listEl.appendChild(createAspectRow(a)));
    }

    /* ============================================================
       MODAL (tooltip-style info + slider)
    ============================================================ */
    const dlg = el('#infoModal');
    const mTitle = el('#mTitle');
    const mDef = el('#mDef');
    const mBrain = el('#mBrain');
    const mNT = el('#mNT');
    const mEnergy = el('#mEnergy');
    const mStage = el('#mStage');
    const mSlider = el('#mSlider');
    const mActVal = el('#mActVal');
    const mSummary = el('#mSummary');

    let currentAspect = null;

    function openModal(a) {
      currentAspect = a;
      mTitle.textContent = a.name;
      if (mode==='mind') {
        mDef.textContent = a.definition;
        mBrain.textContent = a.nsilSemanticSignature || 'â€”';
        mNT.textContent = `${a.quantumMode || 'â€”'} Â· ${a.particleWaveFieldFunction || ''}`;
        mEnergy.textContent = `${a.semanticGravity || 'â€”'}`;
        mStage.textContent = `Stage ${a.stage} Â· Ring ${a.ring}`;
      } else if (mode==='body') {
        mDef.textContent = a.definition;
        mBrain.textContent = a.brainRegion;
        mNT.textContent = a.neurotransmitter;
        mEnergy.textContent = a.energyMode;
        mStage.textContent = `Stage ${a.stage} Â· Ring ${a.ring}`;
      } else {
        mDef.textContent = a.definition;
        mBrain.textContent = a.archetypalSymbol || 'â€”';
        mNT.textContent = a.spiritualRole || 'â€”';
        mEnergy.textContent = a.nsilPrincipleSignature || 'â€”';
        mStage.textContent = `Stage ${a.stage} Â· Ring ${a.ring}`;
      }
      mSlider.value = String(a.activation);
      mActVal.textContent = String(a.activation);
      updateModalSummary();
      dlg.showModal();
    }

    function updateModalSummary() {
      if (!currentAspect) return;
      const energyIn = currentAspect.activation;
      const region = currentAspect.brainRegion || 'â€”';
      const ntStr = String(currentAspect.neurotransmitter || 'â€”');
      const neuroOut = ntStr.split(' ')[0];
      const metabolic = Math.round((energyIn/100) * 100);
      mSummary.textContent = `Energy in: ${energyIn} â†’ ${region} â†’ NT: ${neuroOut} â†’ functional output: ${currentAspect.matterOutput || 'â€”'} (metabolic load â‰ˆ ${metabolic}%)`;
    }

    dlg.addEventListener('close', ()=>{ currentAspect = null; });
    dlg.addEventListener('click', (e)=>{
      const rect = dlg.getBoundingClientRect();
      if (e.clientY < rect.top || e.clientY > rect.bottom || e.clientX < rect.left || e.clientX > rect.right) dlg.close();
    });
    dlg.querySelector('button[value="cancel"]').addEventListener('click', ()=> dlg.close());
    mSlider.addEventListener('input', (e) => {
      if (!currentAspect) return;
      currentAspect.activation = Number(e.target.value);
      mActVal.textContent = String(currentAspect.activation);
      updateModalSummary();
      const row = listEl.querySelector(`[data-id="${currentAspect.id}"]`);
      if (row) {
        const label = row.querySelector('label');
        const range = row.querySelector('input[type="range"]');
        if (range) range.value = String(currentAspect.activation);
        if (label) label.textContent = `Activation: ${currentAspect.activation}`;
      }
      draw();
      updateMetrics();
    });

    /* ============================================================
       CANVAS RENDERING
    ============================================================ */
    const canvas = el('#clock');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const { clientWidth:w, clientHeight:h } = canvas;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      center.x = w/2; center.y = h/2;
      draw();
    }
    window.addEventListener('resize', resizeCanvas);

    function polar(angle, radius) {
      return { x: center.x + Math.cos(angle)*radius, y: center.y + Math.sin(angle)*radius };
    }
    function hsl(h, s=70, l=52) { return `hsl(${h} ${s}% ${l}%)`; }
    function hslAlpha(h, a=.25, s=70, l=50) { return `hsl(${h} ${s}% ${l}% / ${a})`; }

    function drawRings(maxR) {
      const rings = 8;
      const step = maxR / rings;
      ctx.save();
      for (let i=1;i<=rings;i++) {
        ctx.beginPath();
        ctx.strokeStyle = i % 2 ? '#1a214a' : '#161c3f';
        ctx.lineWidth = 1;
        ctx.arc(center.x, center.y, step*i, 0, TWO_PI);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawStageLines(maxR) {
      const count = 12;
      ctx.save();
      ctx.strokeStyle = '#24306f';
      ctx.lineWidth = 1;
      for (let s=0; s<count; s++) {
        const angle = (s/count)*TWO_PI - Math.PI/2;
        const p1 = polar(angle, 10);
        const p2 = polar(angle, maxR);
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawNodes(maxR) {
      const nodeR = 10;
      const radius = maxR * 0.92;
      const out = [];
      aspects.forEach((a, i) => {
        const angle = (i/N_ASPECTS)*TWO_PI - Math.PI/2;
        const p = polar(angle, radius);
        const arcSize = Math.max(0.05, a.activation/100) * (TWO_PI / N_ASPECTS);
        ctx.beginPath();
        ctx.arc(center.x, center.y, radius, angle - arcSize/2, angle + arcSize/2);
        ctx.strokeStyle = hsl(a.hue, 70, 55);
        ctx.lineWidth = 8;
        ctx.globalAlpha = 0.55;
        ctx.stroke();
        ctx.globalAlpha = 1;

        ctx.beginPath();
        ctx.fillStyle = hsl(a.hue, 70, 50);
        ctx.arc(p.x, p.y, nodeR, 0, TWO_PI);
        ctx.fill();
        ctx.lineWidth = (a.id === state.focusId) ? 3 : 1.5;
        ctx.strokeStyle = (a.id === state.focusId) ? '#fde68a' : '#0b0f2a';
        ctx.stroke();

        ctx.fillStyle = '#cbd5f1';
        ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI';
        ctx.textAlign = 'center';
        ctx.fillText(a.name, p.x, p.y - (nodeR+8));

        out.push({ id: a.id, x: p.x, y: p.y, angle });
      });
      return out;
    }

    function drawResonanceLinks(nodePoints) {
      ctx.save();
      for (let i=0;i<aspects.length;i++) {
        for (let j=i+1;j<aspects.length;j++) {
          const ai = aspects[i], aj = aspects[j];
          const sim = Math.abs(ai.activation - aj.activation);
          const sameStage = (ai.stage === aj.stage);
          const sameRing = (ai.ring === aj.ring);
          const shouldLink = sim <= state.resonanceThreshold || sameStage || sameRing;
          if (!shouldLink) continue;
          const pi = nodePoints[i], pj = nodePoints[j];
          const d = Math.hypot(pi.x - pj.x, pi.y - pj.y);
          const alpha = Math.min(0.35, 0.08 + (1 - sim/100) * 0.25) * (sameStage ? 1.25 : 1) * (sameRing ? 1.15 : 1);
          ctx.beginPath();
          const grad = ctx.createLinearGradient(pi.x, pi.y, pj.x, pj.y);
          grad.addColorStop(0, 'rgba(52, 211, 153, '+alpha.toFixed(3)+')');
          grad.addColorStop(1, 'rgba(125, 211, 252, '+alpha.toFixed(3)+')');
          ctx.strokeStyle = grad;
          ctx.lineWidth = Math.max(0.5, 2.5 - (d/260));
          ctx.moveTo(pi.x, pi.y);
          ctx.lineTo(pj.x, pj.y);
          ctx.stroke();
        }
      }
      ctx.restore();
    }

    function drawTutorialHalo(nodePoints) {
      if (!state.tutorial) return;
      const idx = (state.tutorialIndex % aspects.length);
      const { x, y } = nodePoints[idx];
      const t = performance.now()/1000;
      const pulse = 10 + 6*Math.sin(t*2);
      ctx.save();
      const g = ctx.createRadialGradient(x, y, 2, x, y, 42+pulse);
      g.addColorStop(0, 'rgba(245, 158, 11, 0.7)');
      g.addColorStop(1, 'rgba(245, 158, 11, 0.0)');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(x, y, 42+pulse, 0, TWO_PI);
      ctx.fill();
      ctx.restore();
    }

    function draw() {
      const { width:w, height:h } = canvas;
      ctx.clearRect(0,0,w,h);
      const maxR = Math.min(w, h)/2 - 30;
      drawRings(maxR);
      drawStageLines(maxR);
      const points = drawNodes(maxR);
      drawResonanceLinks(points);
      drawTutorialHalo(points);
    }
    
    function tick() { if (state.tutorial) draw(); requestAnimationFrame(tick); }

    // --- INTERACTION ---
    function getMousePos(evt) {
      const rect = canvas.getBoundingClientRect();
      return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }

    function nodeAt(x, y) {
      const { width:w, height:h } = canvas;
      const maxR = Math.min(w, h)/2 - 30; const radius = maxR * 0.92; const nodeR = 12;
      for (let i=0;i<aspects.length;i++) {
        const angle = (i/N_ASPECTS)*TWO_PI - Math.PI/2;
        const p = polar(angle, radius);
        if (Math.hypot(x - p.x, y - p.y) <= nodeR+2) return aspects[i];
      }
      return null;
    }

    canvas.addEventListener('click', (e)=>{
      const p = getMousePos(e);
      const a = nodeAt(p.x, p.y);
      if (a) { state.focusId = a.id; refreshListSelection(); draw(); openModal(a); }
    });

    // --- LIST BUILDING & UI ---
    function tagHTML(a){
      if (mode==='mind') {
        return `<span class="tag">${a.quantumMode}</span><span class="tag">NSIL</span><span class="tag">${a.semanticGravity}</span>`;
      } else if (mode==='body') {
        return `<span class="tag">${a.brainRegion}</span><span class="tag">${String(a.neurotransmitter||'â€”').split(' ')[0]}</span><span class="tag">${a.energyMode}</span>`;
      }
      return `<span class="tag">${a.archetypalSymbol}</span><span class="tag">${a.spiritualRole}</span><span class="tag">NSIL</span>`;
    }

    function createAspectRow(a) {
      const item = document.createElement('div');
      item.className = 'aspect-item';
      item.setAttribute('role', 'option');
      item.tabIndex = 0;
      item.dataset.id = a.id;
      item.setAttribute('aria-selected', a.id === state.focusId ? 'true' : 'false');

      const r1 = document.createElement('div');
      r1.className = 'row';
      r1.innerHTML = `<div class="name"><span class="dot" style="background:${hsl(a.hue)}"></span>${a.name}</div>
                      <span class="badge">Stage ${a.stage} Â· Ring ${a.ring}</span>`;

      const bar = document.createElement('div');
      bar.className = 'activation-bar';
      const barFill = document.createElement('span');
      barFill.style.width = `${a.activation}%`;
      barFill.style.background = `linear-gradient(90deg, ${hsl(a.hue, 70, 55)}, ${hslAlpha(a.hue, 0.45, 70, 55)})`;
      bar.appendChild(barFill);

      const r2 = document.createElement('div');
      r2.className = 'row';
      const label = document.createElement('label');
      label.textContent = `Activation: ${a.activation}`;
      label.style.flex = '1';
      label.htmlFor = `rng-${a.id}`;

      const range = document.createElement('input');
      range.type = 'range';
      range.min = 0;
      range.max = 100;
      range.value = a.activation;
      range.id = `rng-${a.id}`;
      range.style.flex = '1';
      range.setAttribute('aria-label', `${a.name} activation`);
      range.addEventListener('input', (e) => {
        a.activation = Number(e.target.value);
        label.textContent = `Activation: ${a.activation}`;
        barFill.style.width = `${a.activation}%`;
        draw();
        updateMetrics();
      });
      range.addEventListener('change', () => { state.focusId = a.id; buildList(); });

      const detailsBtn = document.createElement('button');
      detailsBtn.className = 'btn tertiary small';
      detailsBtn.type = 'button';
      detailsBtn.textContent = 'Details';
      detailsBtn.addEventListener('click', () => openModal(a));

      r2.append(label, range, detailsBtn);
      const r3 = document.createElement('div');
      r3.className = 'tags';
      r3.innerHTML = `${tagHTML(a)}`;
      item.append(r1, bar, r2, r3);

      item.addEventListener('click', () => { state.focusId = a.id; refreshListSelection(); draw(); });
      item.addEventListener('focus', () => { state.focusId = a.id; refreshListSelection(); draw(); });
      return item;
    }

    function refreshListSelection() {
      if (!listEl) return;
      listEl.querySelectorAll('[data-id]').forEach(ch => ch.setAttribute('aria-selected', ch.dataset.id == state.focusId ? 'true':'false'));
    }

    function buildList() {
      if (!listEl) return;
      listEl.innerHTML = '';
      const needle = state.filterText.trim().toLowerCase();
      const filtered = aspects.filter(a => {
        if (state.stageFilter !== 'all' && String(a.stage) !== state.stageFilter) return false;
        if (state.ringFilter !== 'all' && String(a.ring) !== state.ringFilter) return false;
        if (state.activeOnly && a.activation <= 0) return false;
        if (needle) return a.name.toLowerCase().includes(needle);
        return true;
      });

      if (!filtered.length) {
        listEl.innerHTML = '<div class="empty-state">No aspects match.</div>';
        return;
      }
      filtered.forEach(a => listEl.appendChild(createAspectRow(a)));
      refreshListSelection();
    }

    // --- MODAL & UI ---
    function describeBrain(key, fallback) {
       if (!key) return fallback || 'â€”';
       const def = BIO_LIBRARY.brain[key];
       if (!def) return fallback || key;
       return `<strong>${def.name}</strong><br><span class="vis-hint">${def.summary}</span>`;
    }
    function describeNeurochemical(key, fallback) {
       if (!key) return fallback || 'â€”';
       const def = BIO_LIBRARY.nt[key];
       if (!def) return fallback || key;
       return `<strong>${def.name}</strong><br><span class="vis-hint">${def.summary}</span>`;
    }
    function describeMode(key, fallback) {
       if (!key) return fallback || 'â€”';
       const def = BIO_LIBRARY.modes[key];
       if (!def) return fallback || key;
       return `<strong>${def.name}</strong><br><span class="vis-hint">${def.summary}</span>`;
    }

    function openModal(a) {
       const mTitle = el('#mTitle');
       const mDef = el('#mDef');
       const mBrain = el('#mBrain');
       const mNT = el('#mNT');
       const mEnergy = el('#mEnergy');
       const mStage = el('#mStage');
       const mSlider = el('#mSlider');
       const mActVal = el('#mActVal');
       const mSummary = el('#mSummary');
       
       mTitle.textContent = a.name;
       if (mode==='mind') {
         mDef.textContent = a.definition;
         mBrain.textContent = a.nsilSemanticSignature || 'â€”';
         mNT.textContent = `${a.quantumMode || 'â€”'} Â· ${a.particleWaveFieldFunction || ''}`;
         mEnergy.textContent = `${a.semanticGravity || 'â€”'}`;
         mStage.textContent = `Stage ${a.stage} Â· Ring ${a.ring}`;
       } else if (mode==='body') {
         mDef.textContent = a.definition;
         mBrain.innerHTML = describeBrain(a.brainRegionKey, a.brainRegion);
         mNT.innerHTML = describeNeurochemical(a.neurotransmitterKey, a.neurotransmitter);
         mEnergy.innerHTML = describeMode(a.energyModeKey, a.energyMode);
         mStage.textContent = `Stage ${a.stage} Â· Ring ${a.ring}`;
       } else {
         mDef.textContent = a.definition;
         mBrain.textContent = a.archetypalSymbol || 'â€”';
         mNT.textContent = a.spiritualRole || 'â€”';
         mEnergy.textContent = a.nsilPrincipleSignature || 'â€”';
         mStage.textContent = `Stage ${a.stage} Â· Ring ${a.ring}`;
       }
       mSlider.value = String(a.activation);
       mActVal.textContent = String(a.activation);
       mSummary.textContent = `Energy in: ${a.activation} â†’ functional output`;
       
       const dlg = el('#infoModal');
       dlg.showModal();
       
       // Handle slider in modal
       mSlider.oninput = (e) => {
         a.activation = Number(e.target.value);
         mActVal.textContent = a.activation;
         updateMetrics();
         draw();
         buildList(); // Update the sidebar slider to match
       };
       dlg.querySelector('button[value="cancel"]').onclick = () => dlg.close();
    }

    function updateMetrics() {
      const metrics = computeSCI();
      const { mean, std, sci, resonanceScore } = metrics;
      if (sciEl) sciEl.innerHTML = `${sci.toFixed(1)}<small>Î¼=${mean.toFixed(1)}, Ïƒ=${std.toFixed(1)}</small>`;
      
      const { total, metabolic } = computeEnergyMatter();
      if (emEl) emEl.textContent = `Î£E=${Math.round(total)} Â· Metabolic ${(metabolic*100).toFixed(0)}%`;
      
      const activeCount = aspects.filter(a => a.activation > 0).length;
      if (activeEl) activeEl.textContent = `${activeCount}/${N_ASPECTS}`;
      
      const peak = aspects.reduce((best, cand) => (cand.activation > (best?.activation ?? -1) ? cand : best), null);
      if (peakEl) peakEl.innerHTML = peak ? `${peak.activation}<small>${peak.name}</small>` : 'â€”';
    }
    // Basic keyboard navigation
    window.addEventListener('keydown', (e)=>{
      const key = e.key.toLowerCase();
      if (key === 't') { toggleTutorial(); }
      if (key === 'r') { randomize(); }
      if (key === 'e') { exportJSON(); }
      if (key === '0') { deactivateAll(); }
      if (key === 'arrowright' || key === 'arrowdown') { e.preventDefault(); moveFocus(1); }
      if (key === 'arrowleft' || key === 'arrowup') { e.preventDefault(); moveFocus(-1); }
      if (key === 'enter') { e.preventDefault(); const a = aspects.find(x=>x.id===state.focusId); if (a) openModal(a); }
    });

    function moveFocus(delta) {
      const idx = aspects.findIndex(a => a.id === state.focusId);
      const next = (idx + delta + aspects.length) % aspects.length;
      state.focusId = aspects[next].id;
      refreshListSelection();
      draw();
      const row = listEl.querySelector(`[data-id="${state.focusId}"]`);
      row?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    /* ============================================================
       COMMANDS & EXPORT
    ============================================================ */
    function randomize() {
      aspects.forEach(a => a.activation = Math.round(Math.random()*100));
      syncListRanges(); draw(); updateMetrics();
    }

    function deactivateAll() {
      aspects.forEach(a => a.activation = 0);
      syncListRanges(); draw(); updateMetrics();
    }

    function syncListRanges() {
      aspects.forEach(a => {
        const row = listEl.querySelector(`[data-id="${a.id}"]`);
        if (!row) return;
        const range = row.querySelector('input[type="range"]');
        const label = row.querySelector('label');
        if (range) range.value = a.activation;
        if (label) label.textContent = `Activation: ${a.activation}`;
      });
    }

    // Build payload separately so we can unit-test it
    function buildExportPayload() {
      const { mean, std, sci } = computeSCI();
      const { total, byNT, metabolic } = computeEnergyMatter();
      return {
        generatedAt: new Date().toISOString(),
        model: `32 Aspect Developmental Self Clock â€” ${mode}`,
        devStage: state.devStage,
        metrics: { mean, std, sci },
        energyMatter: { total, byNT: Object.fromEntries(byNT), metabolic },
        aspects: aspects
      };
    }

    function exportJSON() {
      const payload = buildExportPayload();
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'self-clock-export.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    /* ============================================================
       TUTORIAL / WALKTHROUGH MODE
    ============================================================ */
    let tutorialTimer = null;
    function toggleTutorial() {
      state.tutorial = !state.tutorial;
      el('#btnTutorial').setAttribute('aria-pressed', String(state.tutorial));
      el('#btnTutorial').textContent = state.tutorial ? 'â¸ Tutorial' : 'â–¶ Tutorial';
      if (state.tutorial) {
        if (!tutorialTimer) tutorialTimer = setInterval(()=>{
          state.tutorialIndex = (state.tutorialIndex + 1) % aspects.length;
          state.focusId = aspects[state.tutorialIndex].id;
          refreshListSelection(); draw();
        }, 1400);
      } else {
        clearInterval(tutorialTimer); tutorialTimer = null; draw();
      }
    }

    /* ============================================================
       UI WIRING
    ============================================================ */
    el('#btnTutorial').addEventListener('click', toggleTutorial);
    el('#btnRandomize').addEventListener('click', randomize);
    el('#btnDeactivate').addEventListener('click', deactivateAll);
    el('#btnExport').addEventListener('click', exportJSON);

    function setMode(newMode){
      mode = newMode;
      aspects = (mode==='mind') ? mindAspects : (mode==='body') ? bodyAspects : soulAspects;
      el('#modeMind').classList.toggle('secondary', mode!=='mind');
      el('#modeBody').classList.toggle('secondary', mode!=='body');
      el('#modeSoul').classList.toggle('secondary', mode!=='soul');
      el('#modeMind').setAttribute('aria-pressed', String(mode==='mind'));
      el('#modeBody').setAttribute('aria-pressed', String(mode==='body'));
      el('#modeSoul').setAttribute('aria-pressed', String(mode==='soul'));
      buildList();
      updateMetrics();
      draw();
    }

    function stageLabel(stageIndex) {
      const name = DEV_STAGE_LABELS[stageIndex] || '';
      return `Stage ${stageIndex + 1}${name ? ` Â· ${name}` : ''}`;
    }

    function applyDevStage(stage){
      state.devStage = stage;
      if (devVal) devVal.textContent = stageLabel(stage);
      aspects.forEach(a => {
        if (a.devProfile?.length === DEV_STAGES) {
          const base = a.devProfile[stage] ?? 0;
          const weight = state.stageWeights[(a.stage - 1) % state.stageWeights.length] ?? 1;
          a.activation = Math.max(0, Math.min(100, Math.round(base * weight)));
        }
      });
      updateMetrics();
      buildList();
      draw();
    }

    function randomize() {
       aspects.forEach(a => a.activation = Math.floor(Math.random()*100));
       updateMetrics();
       buildList();
       draw();
    }
    function deactivateAll() {
       aspects.forEach(a => a.activation = 0);
       updateMetrics();
       buildList();
       draw();
    }

    // --- INIT ---
    // Event listeners
    if (searchInput) {
      searchInput.addEventListener('input', (e)=> { state.filterText = e.target.value || ''; buildList(); });
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const text = e.target.value;
          if (text.length > 3) igniteTheMirror(text);
        }
      });
    }

    el('#modeMind').addEventListener('click', ()=> setMode('mind'));
    el('#modeBody').addEventListener('click', ()=> setMode('body'));
    el('#modeSoul').addEventListener('click', ()=> setMode('soul'));
    if(themeBtn) themeBtn.addEventListener('click', ()=> applyTheme(state.theme === 'dark' ? 'light' : 'dark'));
    if(devSlider) devSlider.addEventListener('input', (e)=> applyDevStage(Number(e.target.value)));
    if(el('#btnRandomize')) el('#btnRandomize').addEventListener('click', randomize);
    if(el('#btnDeactivate')) el('#btnDeactivate').addEventListener('click', deactivateAll);
    if(el('#btnTutorial')) el('#btnTutorial').addEventListener('click', () => {
        state.tutorial = !state.tutorial;
        draw();
        if(state.tutorial) {
             tick();
             if(tutorialDialog) tutorialDialog.showModal();
        }
    });

    if(tutorialListEl) tutorialListEl.innerHTML = TUTORIAL_STEPS.map(step => `<li><strong>${step.title}</strong> â€” ${step.detail}</li>`).join('');

    // Start
    applyTheme(detectInitialTheme());
    /* ============================================================
       SELF-TESTS (basic runtime checks) â€” shown in console
       We add tests since none existed previously.
    ============================================================ */
    function runSelfTests() {
      const results = [];
      function assert(name, cond) { results.push({ name, pass: !!cond }); }

      // Test 1: DEV_STAGES
      assert('DEV_STAGES == 12', DEV_STAGES === 12);

      // Test 2: Each dataset has 32 aspects
      assert('mindAspects length', mindAspects.length === 32);
      assert('bodyAspects length', bodyAspects.length === 32);
      assert('soulAspects length', soulAspects.length === 32);

      // Test 3: devProfile lengths
      assert('mind devProfile[0].length == 12', mindAspects[0].devProfile.length === 12);

      // Test 4: SCI on uniform activations â†’ stdâ‰ˆ0, sciâ‰ˆmean*100
      const bak = aspects;
      aspects = [{ activation: 50 },{ activation: 50 },{ activation: 50 },{ activation: 50 }];
      const { mean, std, sci } = computeSCI();
      assert('SCI std == 0', Math.abs(std - 0) < 1e-9);
      assert('SCI value', Math.abs(sci - (50/(1+0)*100)) < 1e-6);
      aspects = bak;

      // Test 5: export payload shape
      const payload = buildExportPayload();
      assert('payload.aspects length == 32', Array.isArray(payload.aspects) && payload.aspects.length === 32);
      assert('payload.metrics has sci', typeof payload.metrics.sci === 'number');

      // Report
      const passCount = results.filter(r=>r.pass).length;
      const fail = results.filter(r=>!r.pass);
      console.log('%cSelf-tests:', 'font-weight:bold');
      results.forEach(r=> console.log(r.pass ? 'âœ…' : 'âŒ', r.name));
      if (fail.length) {
        console.warn('Some self-tests failed:', fail);
      } else {
        console.log(`All ${passCount} self-tests passed.`);
      }
    }

    // Initial build & draw
    buildList();
    updateMetrics();
    resizeCanvas();
    applyDevStage(state.devStage);
    updateMetrics();

    /* ============================================================
       SCIENCE NOTES (for researchers inside code comments)
       ----------------------------------------------------
       â€¢ SCI implements the user's formula: mean/(1+stddev)*100.
       â€¢ We visualize C = E Ã— MC (concept â†’ energy Ã— matter Ã— cognition) via
         the info modal's pipeline description and resonance links.
       â€¢ 12 radial cross-lines = expanded Erikson-like developmental stages; 
         use your mapping to stage names in your dataset if available.
       â€¢ 8 concentric rings = anatomy/energy zones; link to somatic/energetic
         layers (e.g., brainstem â†’ cortex, fascia layers, chakric analogues).
       â€¢ Resonance edges connect nodes with similar activation OR sharing
         stage/ring, encoding feedback/overlap and nonlinearity.
       â€¢ Tutorial traces a simple loop through aspects. For research demos,
         extend by adding causal/feedback animations (mindâ†’bodyâ†’actionâ†’mind).
       â€¢ Accessibility: All controls are reachable by keyboard; modal is a
         native <dialog>; listbox items are focusable and announce changes.
    ============================================================ */
  </script>

    <footer style="text-align: center; padding: 2rem; margin-top: 2rem; border-top: 1px solid var(--glass-stroke); background: var(--panel);">
    <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
      <div class="vis-hint" style="color: var(--muted);">Explore the developmental milestones</div>
      <a href="self-clock.html" class="btn" style="text-decoration: none;">View Full Self Clock â†’</a>
      <a href="about.html" class="btn secondary" style="text-decoration: none;">About</a>
    </div>
  </footer>

</body>
</html>
